<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quick Quote | App Testable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; color: #0f172a; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-mic { animation: pulse 1.5s infinite; background: #ef4444 !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen pb-24">

    <header class="p-6 flex justify-between items-center sticky top-0 z-40 bg-[#f1f5f9]/80 backdrop-blur-md">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight">QUICK<span class="text-blue-600">QUOTE</span></h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Version Test Opérationnelle</p>
        </div>
        <button onclick="toggleSettings()" class="p-3 rounded-2xl glass shadow-sm"><i data-lucide="settings" class="w-5 h-5"></i></button>
    </header>

    <main class="px-5">
        
        <section id="screen-dictation" class="tab-content active space-y-6">
            <div class="glass rounded-[2.5rem] p-8 min-h-[250px] shadow-xl flex flex-col justify-between relative">
                <div id="transcript-container" class="space-y-4 overflow-y-auto max-h-[180px] no-scrollbar">
                    <p id="transcript-text" class="text-lg text-slate-400 italic leading-relaxed">
                        Appuyez sur le micro et dites par exemple : "20 mètres de parquet et 5 sacs de ciment"
                    </p>
                </div>
                <div class="flex justify-between items-center mt-4">
                    <span id="recording-status" class="text-[10px] font-bold text-slate-400 uppercase flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-slate-300"></span> Prêt
                    </span>
                    <button onclick="processAI()" class="bg-blue-600 text-white px-6 py-2 rounded-full text-xs font-bold shadow-lg flex items-center gap-2 active:scale-95 transition-all">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> ANALYSER
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-xs font-bold text-slate-500 uppercase px-2 tracking-widest">Aperçu rapide</h3>
                <div id="quick-items-preview" class="space-y-2 text-center py-4 text-slate-400 text-sm glass rounded-2xl">
                    Aucun élément détecté
                </div>
            </div>
        </section>

        <section id="screen-edit" class="tab-content space-y-6">
            <div class="glass rounded-[2.2rem] p-6 shadow-xl border-white/60">
                <div class="flex justify-between mb-6">
                    <div class="text-left"><h2 class="font-bold text-sm">DEVIS PRO</h2><p id="quote-date" class="text-[10px] text-slate-400"></p></div>
                    <button onclick="clearQuote()" class="text-red-500 text-[10px] font-bold uppercase">Vider</button>
                </div>
                <div id="edit-table" class="space-y-4 min-h-[100px]">
                    </div>
                <div class="mt-8 pt-6 border-t border-slate-200 space-y-3">
                    <div class="flex justify-between text-sm"><span class="text-slate-400">Total HT</span><span id="ht-total" class="font-bold text-slate-700">0,00 €</span></div>
                    <div class="flex justify-between text-xl font-black text-blue-600 uppercase"><span>Total TTC</span><span id="ttc-total">0,00 €</span></div>
                </div>
            </div>
            <button onclick="exportToPDF()" class="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-bold shadow-2xl flex items-center justify-center gap-4 active:scale-95 transition-all">
                <i data-lucide="file-text"></i> GÉNÉRER LE PDF
            </button>
        </section>

        <section id="screen-catalog" class="tab-content space-y-6">
            <h3 class="text-xs font-bold text-slate-500 uppercase px-2">Cliquez pour ajouter au devis</h3>
            <div id="catalog-grid" class="grid grid-cols-1 gap-3">
                </div>
        </section>

        <section id="screen-ged" class="tab-content space-y-4">
            <div id="history-list" class="space-y-4"></div>
        </section>

    </main>

    <nav class="fixed bottom-0 inset-x-0 h-24 glass border-t border-white/50 flex items-center justify-around px-4 z-50">
        <button onclick="switchTab('dictation')" class="nav-item flex flex-col items-center gap-1 text-slate-400" data-target="dictation"><i data-lucide="mic" class="w-6 h-6"></i><span class="text-[9px] font-bold">DICTÉE</span></button>
        <button onclick="switchTab('edit')" class="nav-item flex flex-col items-center gap-1 text-slate-400" data-target="edit"><i data-lucide="file-edit" class="w-6 h-6"></i><span class="text-[9px] font-bold">DEVIS</span></button>
        <div class="relative -top-6">
            <button id="main-mic-btn" onclick="toggleRecording()" class="w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center border-4 border-[#f1f5f9]"><i data-lucide="mic" id="mic-icon" class="w-8 h-8"></i></button>
        </div>
        <button onclick="switchTab('catalog')" class="nav-item flex flex-col items-center gap-1 text-slate-400" data-target="catalog"><i data-lucide="shopping-bag" class="w-6 h-6"></i><span class="text-[9px] font-bold">STOCK</span></button>
        <button onclick="switchTab('ged')" class="nav-item flex flex-col items-center gap-1 text-slate-400" data-target="ged"><i data-lucide="archive" class="w-6 h-6"></i><span class="text-[9px] font-bold">GED</span></button>
    </nav>

    <div id="modal-settings" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6">
        <div class="glass w-full max-w-sm rounded-[2.5rem] p-8 space-y-6 text-center">
            <h2 class="text-xl font-bold">Configuration</h2>
            <input type="password" id="api-key" placeholder="Clé API Gemini (Optionnel)" class="w-full p-4 rounded-2xl border-none ring-1 ring-slate-200 outline-none">
            <button onclick="toggleSettings()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">Fermer</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        let isRecording = false;
        let recognition;
        let quoteItems = [];
        const catalog = [
            { id: 1, name: "Parquet Chêne", price: 45.00, brand: "Leroy Merlin" },
            { id: 2, name: "Ciment 35kg", price: 7.50, brand: "Point.P" },
            { id: 3, name: "Peinture Blanche 10L", price: 89.00, brand: "Casto" },
            { id: 4, name: "Main d'œuvre", price: 55.00, brand: "Artisan" }
        ];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            document.getElementById('quote-date').innerText = new Date().toLocaleDateString('fr-FR');
            initSpeech();
            renderCatalog();
            renderHistory();
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`screen-${tabId}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('text-blue-600');
                if(n.dataset.target === tabId) n.classList.add('text-blue-600');
            });
        }

        // --- SPEECH ENGINE ---
        function initSpeech() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (window.SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.onresult = (e) => {
                    const text = Array.from(e.results).map(r => r[0].transcript).join('');
                    document.getElementById('transcript-text').innerText = text;
                    document.getElementById('transcript-text').classList.replace('text-slate-400', 'text-slate-900');
                };
            }
        }

        function toggleRecording() {
            const btn = document.getElementById('main-mic-btn');
            const status = document.getElementById('recording-status');
            if (!isRecording) {
                try {
                    recognition.start();
                    isRecording = true;
                    btn.classList.add('pulse-mic');
                    status.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500 animate-ping"></span> ÉCOUTE...`;
                } catch(e) { alert("Micro non supporté ou déjà actif"); }
            } else {
                recognition.stop();
                isRecording = false;
                btn.classList.remove('pulse-mic');
                status.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> TERMINÉ`;
            }
        }

        // --- LOGIQUE MÉTIER ---
        function processAI() {
            const text = document.getElementById('transcript-text').innerText.toLowerCase();
            const segments = text.split(/et|,|puis/);
            
            segments.forEach(seg => {
                const qtyMatch = seg.match(/\d+/);
                const qty = qtyMatch ? parseInt(qtyMatch[0]) : 1;
                
                // Recherche dans le catalogue
                const found = catalog.find(p => seg.includes(p.name.toLowerCase().split(' ')[0]));
                
                if (found) {
                    addItem(found.name, qty, found.price);
                } else if (seg.length > 5) {
                    addItem(seg.trim(), qty, 0, true);
                }
            });

            renderEditTable();
            renderPreview();
            switchTab('edit');
        }

        function addItem(name, qty, price, isEst = false) {
            quoteItems.push({ 
                id: Date.now() + Math.random(),
                desc: name.charAt(0).toUpperCase() + name.slice(1), 
                qty: qty, 
                price: price, 
                est: isEst 
            });
        }

        function addToQuoteFromCatalog(id) {
            const p = catalog.find(x => x.id === id);
            addItem(p.name, 1, p.price);
            renderEditTable();
            alert("Ajouté : " + p.name);
        }

        function updateItem(id, field, value) {
            const item = quoteItems.find(x => x.id === id);
            if(item) {
                item[field] = field === 'desc' ? value : parseFloat(value);
                calculateTotals();
            }
        }

        function removeItem(id) {
            quoteItems = quoteItems.filter(x => x.id !== id);
            renderEditTable();
        }

        function clearQuote() {
            if(confirm("Vider le devis ?")) {
                quoteItems = [];
                renderEditTable();
            }
        }

        // --- RENDERING ---
        function renderEditTable() {
            const container = document.getElementById('edit-table');
            if(quoteItems.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-300 py-10 text-xs italic">Le devis est vide</p>`;
            } else {
                container.innerHTML = quoteItems.map(item => `
                    <div class="grid grid-cols-12 gap-2 items-center border-b border-slate-100 pb-3">
                        <div class="col-span-6">
                            <input type="text" value="${item.desc}" onchange="updateItem(${item.id}, 'desc', this.value)" class="w-full bg-transparent text-[11px] font-bold outline-none">
                        </div>
                        <div class="col-span-2">
                            <input type="number" value="${item.qty}" onchange="updateItem(${item.id}, 'qty', this.value)" class="w-full bg-slate-100 rounded-lg p-1 text-center text-[11px] outline-none">
                        </div>
                        <div class="col-span-3">
                            <input type="number" value="${item.price}" onchange="updateItem(${item.id}, 'price', this.value)" class="w-full bg-transparent text-right text-[11px] font-black outline-none">
                        </div>
                        <button onclick="removeItem(${item.id})" class="col-span-1 text-slate-300 text-lg">&times;</button>
                    </div>
                `).join('');
            }
            calculateTotals();
        }

        function renderPreview() {
            const preview = document.getElementById('quick-items-preview');
            preview.innerHTML = quoteItems.map(i => `
                <div class="flex justify-between text-[10px] font-bold px-4 py-1">
                    <span>${i.qty} x ${i.desc.substring(0,15)}...</span>
                    <span>${(i.qty * i.price).toFixed(2)}€</span>
                </div>
            `).join('');
        }

        function calculateTotals() {
            const ht = quoteItems.reduce((acc, curr) => acc + (curr.qty * curr.price), 0);
            document.getElementById('ht-total').innerText = ht.toFixed(2) + " €";
            document.getElementById('ttc-total').innerText = (ht * 1.2).toFixed(2) + " €";
        }

        function renderCatalog() {
            document.getElementById('catalog-grid').innerHTML = catalog.map(p => `
                <div onclick="addToQuoteFromCatalog(${p.id})" class="glass p-5 rounded-[2rem] flex justify-between items-center active:scale-95 transition-all cursor-pointer">
                    <div>
                        <p class="text-[10px] font-bold text-blue-600 uppercase">${p.brand}</p>
                        <h4 class="font-bold text-sm">${p.name}</h4>
                        <p class="text-xs text-slate-400">${p.price.toFixed(2)}€ HT</p>
                    </div>
                    <div class="bg-blue-600 text-white p-2 rounded-full"><i data-lucide="plus" class="w-4 h-4"></i></div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderHistory() {
            const history = [
                { client: "M. Lefebvre", total: "1,240.00", date: "26/01/2026" },
                { client: "Mme. Zenari", total: "850.50", date: "25/01/2026" }
            ];
            document.getElementById('history-list').innerHTML = history.map(h => `
                <div class="glass p-5 rounded-[2rem]">
                    <div class="flex justify-between items-center">
                        <div><h4 class="font-bold">${h.client}</h4><p class="text-[10px] text-slate-400">${h.date}</p></div>
                        <span class="text-blue-600 font-black">${h.total} €</span>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function exportToPDF() {
            if(quoteItems.length === 0) return alert("Devis vide !");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("DEVIS QUICK QUOTE", 10, 20);
            doc.setFontSize(10);
            doc.text("Date: " + new Date().toLocaleDateString(), 10, 30);
            
            const tableData = quoteItems.map(i => [i.desc, i.qty, i.price.toFixed(2) + "€", (i.qty * i.price).toFixed(2) + "€"]);
            doc.autoTable({
                startY: 40,
                head: [['Désignation', 'Qté', 'P.U HT', 'Total HT']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [37, 99, 235] }
            });
            doc.save("devis.pdf");
        }

        function toggleSettings() { document.getElementById('modal-settings').classList.toggle('hidden'); }
    </script>
</body>
</html>
